<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ÏΩïÏßëÏñ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @font-face {
      font-family: 'Pretendard-Regular';
      src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
    }
    * {
      box-sizing: border-box;
    }
    :root {
      --brand-color: #FFB74D;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Pretendard-Regular', sans-serif;
      background: #fff;
      color: #333;
      user-select: none;
    }

    /* ÏãúÏûë ÌôîÎ©¥ */
    #startScreen {
      width: 400px;
      background: white;
      border-radius: 12px;
      padding: 30px 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      user-select: text;
    }

    #startScreen h1 {
      margin-bottom: 20px;
      font-size: 35px;
      font-weight: 800;
      color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    #startScreen h1 svg {
      width: 26px;
      height: 26px;
      fill: var(--brand-color);
    }

    #placeNameInput {
      background-color: #F0F0F0;
      width: 100%;
      padding: 10px 14px;
      font-size: 16px;
      border: none;
      border-radius: 20px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
      height: 50px;
    }

    #placeNameInput:focus {
      border-color: var(--brand-color);
      outline: none;
    }

    #uploadBtn {
      display: none;
    }

    #uploadLabel {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 50px;
      padding: 12px 0;
      font-size: 16px;
      background: var(--brand-color);
      border: none;
      border-radius: 20px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #uploadLabel:hover {
      background: var(--brand-color);
    }

    /* Î©îÏù∏ ÌôîÎ©¥ Ï†ÑÏ≤¥ Ïª®ÌÖåÏù¥ÎÑà */
    #mainApp {
      display: none;
      height: 100vh;
      width: 100vw;
      background: #fff8e1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* ÏÇ¨Ïù¥ÎìúÎ∞î (Î¨ºÍ±¥ Î¶¨Ïä§Ìä∏, ÌûàÏä§ÌÜ†Î¶¨ Îì±) */
    #sidebar {
      width: 320px;
      background: var(--brand-color);
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      gap: 10px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      user-select: text;
    }

    #sidebar h2 {
      margin: 0 0 10px 0;
      font-weight: 700;
      font-size: 20px;
      color: #3e2723;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }

    #sidebar h2 svg {
      width: 18px;
      height: 18px;
      fill: #3e2723;
    }

    /* ÌÉ≠ Î©îÎâ¥ */
    #tabMenu {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabButton {
      flex: 1;
      padding: 8px 0;
      background: #fff3e0;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      color: #6d4c41;
      cursor: pointer;
      border: 2px solid transparent;
      transition: background-color 0.3s, border-color 0.3s;
      text-align: center;
      user-select: none;
    }

    .tabButton.active {
      background: white;
      border-color: #ff8c00;
      color: #e65100;
    }

    /* Î≤ÑÌäº Í∑∏Î£π */
    #actionButtons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    button.actionBtn {
      flex: 1;
      background: #ffa726;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      padding: 10px 0;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    button.actionBtn:hover {
      background: #fb8c00;
    }

    button.actionBtn:disabled {
      background: #ffd180;
      cursor: default;
    }

    /* Î¨ºÍ±¥ Î¶¨Ïä§Ìä∏ */
    #pinList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 10px 6px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
    }

    .pinItem {
      background: white;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s;
      user-select: none;
    }

    .pinItem:hover {
      background-color: #fff8e1;
    }

    .pinEmoji {
      font-size: 22px;
      user-select: none;
      width: 30px;
      text-align: center;
      flex-shrink: 0;
    }

    .pinName {
      flex: 1;
      font-weight: 600;
      font-size: 16px;
      color: #4e342e;
      user-select: text;
    }

    .pinStatus {
      font-size: 13px;
      color: #999;
      flex-shrink: 0;
      user-select: none;
    }

    /* ÌûàÏä§ÌÜ†Î¶¨ Î¶¨Ïä§Ìä∏ */
    #historyList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      color: #5d4037;
      user-select: none;
    }

    .historyItem {
      padding: 6px 8px;
      margin-bottom: 6px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* ÎèÑÎ©¥ Ïª®ÌÖåÏù¥ÎÑà */
    #floorplan-container {
      flex: 1;
      position: relative;
      background: white;
      border-left: 1px solid #ddd;
      overflow: hidden;
      user-select: none;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #floorplan {
      max-width: 100%;
      max-height: 100%;
      user-drag: none;
      user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      transition: transform 0.2s ease-out;
      transform-origin: 0 0;
      display: block;
      position: relative;
    }

    /* ÌïÄ */
    .pin {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ff8c00;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      border: 2.5px solid white;
      box-shadow: 0 0 7px rgba(255, 140, 0, 0.7);
      transition: box-shadow 0.2s;
      user-select: none;
      z-index: 10;
    }
    .pin:after {
      content: attr(data-name);
      font-size: 15px;
      font-weight: 300;
      position: absolute;
      top: 120%;
      left: calc(50% - 13px);
      display: block;
      padding: 4px 8px;
      text-align: center;
      border-radius: 5px;
      opacity: 0;
      transition: 0.5s;
    }

    .pin:hover::after {
      opacity: 1;
    }

    .pin.dragging {
      cursor: grabbing;
      box-shadow: 0 0 14px 4px rgba(255, 140, 0, 0.9);
      z-index: 9999;
    }

    /* ÎèÑÎ©¥ ÏúÑ Î¨ºÍ±¥ Ï∂îÍ∞Ä ÏûÖÎ†• Î∞ïÏä§ */
    #addPinPopup {
      position: absolute;
      background: #fff3e0;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      padding: 15px 18px;
      width: 220px;
      user-select: none;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    #addPinPopup input[type=text] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
    }

    #addPinPopup select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    #addPinPopup button {
      background: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    #addPinPopup button:hover {
      background: #e65100;
    }

    /* Ìé∏Ïßë Î™®Îã¨ */
    #editModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      padding: 24px;
      width: 350px;
      z-index: 2000;
      display: none;
      flex-direction: column;
      user-select: none;
    }

    #editModal input,
    #editModal select,
    #editModal textarea {
      width: 100%;
      margin-bottom: 14px;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      outline: none;
    }

    #editModal textarea {
      resize: vertical;
      height: 80px;
    }

    #editModalButtons {
      display: flex;
      justify-content: space-between;
    }

    #savePinBtn,
    #deletePinBtn,
    #cancelBtn {
      padding: 12px 18px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      flex: 1;
      margin: 0 6px;
      transition: background-color 0.3s;
    }

    #savePinBtn {
      background-color: #4caf50;
      color: white;
    }

    #savePinBtn:hover {
      background-color: #388e3c;
    }

    #deletePinBtn {
      background-color: #f44336;
      color: white;
    }

    #deletePinBtn:hover {
      background-color: #d32f2f;
    }

    #cancelBtn {
      background-color: #9e9e9e;
      color: white;
    }

    #cancelBtn:hover {
      background-color: #616161;
    }
  </style>
</head>

<body>

  <!-- ÏãúÏûë ÌôîÎ©¥ -->
  <div id="startScreen">
    <h1>
      <img src="images/logo.png" width="32px" height="40px">
        <path
          d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
      </svg>
      ÏΩïÏßëÏñ¥
    </h1>
    <input type="text" id="placeNameInput" placeholder="Ïû•ÏÜå Ïù¥Î¶Ñ ÏûÖÎ†•" />
    <label for="uploadBtn" id="uploadLabel">ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</label>
    <input type="file" id="uploadBtn" accept="image/*" />
  </div>

  <!-- Î©îÏù∏ ÌôîÎ©¥ -->
  <div id="mainApp">
    <div id="sidebar">
      <!-- <h2>üè† Ïßë</h2> -->
      <div id="tabMenu">
        <div class="tabButton active" data-tab="pinList">Î¨ºÍ±¥ Î¶¨Ïä§Ìä∏</div>
        <div class="tabButton" data-tab="historyList">Ïù¥Îèô ÌûàÏä§ÌÜ†Î¶¨</div>
      </div>
      <div id="actionButtons">
        <button id="movePinBtn" class="actionBtn">Î¨ºÍ±¥ ÏòÆÍ∏∞Í∏∞</button>
        <button id="addPinBtn" class="actionBtn">Î¨ºÍ±¥ Ï∂îÍ∞Ä</button>
      </div>
      <div id="pinList"></div>
      <div id="historyList" style="display:none;"></div>
    </div>
    <div id="floorplan-container">
      <img id="floorplan" src="" alt="ÎèÑÎ©¥ Ïù¥ÎØ∏ÏßÄ" draggable="false" />

      <!-- Î¨ºÍ±¥ Ï∂îÍ∞Ä ÌåùÏóÖ -->
      <div id="addPinPopup">
        <input type="text" id="newPinName" placeholder="Î¨ºÍ±¥ Ïù¥Î¶Ñ" />
        <input type="text" id="newPinEmoji" placeholder="Ïù¥Î™®ÏßÄ (Ïòà: üìå)" />
        <select id="newPinColor">
          <option value="#ff8c00">Ï£ºÌô©</option>
          <option value="#f44336">Îπ®Í∞ï</option>
          <option value="#4caf50">Ï¥àÎ°ù</option>
          <option value="#2196f3">ÌååÎûë</option>
          <option value="#9c27b0">Î≥¥Îùº</option>
          <option value="#ffeb3b">ÎÖ∏Îûë</option>
        </select>
        <button id="confirmAddPinBtn">Ï∂îÍ∞Ä</button>
      </div>
    </div>
  </div>

  <!-- Ìé∏Ïßë Î™®Îã¨ -->
  <div id="editModal">
    <input type="text" id="editPinName" placeholder="Î¨ºÍ±¥ Ïù¥Î¶Ñ" />
    <input type="text" id="editPinEmoji" placeholder="Ïù¥Î™®ÏßÄ (Ïòà: üìå)" />
    <textarea id="editPinComment" placeholder="ÏΩîÎ©òÌä∏"></textarea>
    <select id="editPinColor">
      <option value="#ff8c00">Ï£ºÌô©</option>
      <option value="#f44336">Îπ®Í∞ï</option>
      <option value="#4caf50">Ï¥àÎ°ù</option>
      <option value="#2196f3">ÌååÎûë</option>
      <option value="#9c27b0">Î≥¥Îùº</option>
      <option value="#ffeb3b">ÎÖ∏Îûë</option>
    </select>
    <div id="editModalButtons">
      <button id="savePinBtn">Ï†ÄÏû•</button>
      <button id="deletePinBtn">ÏÇ≠Ï†ú</button>
      <button id="cancelBtn">Ï∑®ÏÜå</button>
    </div>
  </div>

  <script>
    (() => {
      const startScreen = document.getElementById('startScreen');
      const placeNameInput = document.getElementById('placeNameInput');
      const uploadBtn = document.getElementById('uploadBtn');

      const mainApp = document.getElementById('mainApp');
      const floorplan = document.getElementById('floorplan');
      const floorplanContainer = document.getElementById('floorplan-container');

      const addPinBtn = document.getElementById('addPinBtn');
      const movePinBtn = document.getElementById('movePinBtn');

      const tabButtons = document.querySelectorAll('.tabButton');
      const pinListDiv = document.getElementById('pinList');
      const historyListDiv = document.getElementById('historyList');

      const addPinPopup = document.getElementById('addPinPopup');
      const newPinNameInput = document.getElementById('newPinName');
      const newPinEmojiInput = document.getElementById('newPinEmoji');
      const newPinColorSelect = document.getElementById('newPinColor');
      const confirmAddPinBtn = document.getElementById('confirmAddPinBtn');

      const editModal = document.getElementById('editModal');
      const editPinName = document.getElementById('editPinName');
      const editPinEmoji = document.getElementById('editPinEmoji');
      const editPinComment = document.getElementById('editPinComment');
      const editPinColor = document.getElementById('editPinColor');
      const savePinBtn = document.getElementById('savePinBtn');
      const deletePinBtn = document.getElementById('deletePinBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      let pins = [];
      let history = [];
      let selectedPin = null;
      let isMovingPin = false;

      // Ï¥àÍ∏∞ ÌôîÎ©¥ ÏÑ§Ï†ï
      function init() {
        startScreen.style.display = 'block';
        mainApp.style.display = 'none';
      }

      // ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
      init();

      // ÏóÖÎ°úÎìú Ïãú
      uploadBtn.addEventListener('change', (e) => {
        const file = e.target.files[0];
        const placeName = placeNameInput.value.trim();
        if (!placeName) {
          alert('Ïû•ÏÜå Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
          uploadBtn.value = ''; // Ï¥àÍ∏∞Ìôî
          return;
        }
        if (!file) {
          alert('ÏÇ¨ÏßÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
          return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
          floorplan.src = event.target.result;
          // ÌôîÎ©¥ Ï†ÑÌôò
          startScreen.style.display = 'none';
          mainApp.style.display = 'flex';

          document.title = `ÏΩïÏßëÏñ¥ - ${placeName}`;
          if(mainApp.style.display == 'flex'){
            const sidebar = document.querySelector('#sidebar');
            const h2 = document.createElement('h2');
            h2.textContent = placeNameInput.value;
            const tabmenu = document.querySelector('#tabMenu');
            sidebar.insertBefore(h2, tabmenu);
          }
        };
        reader.readAsDataURL(file);
      });


      // ÌÉ≠ Ï†ÑÌôò
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          tabButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (btn.dataset.tab === 'pinList') {
            pinListDiv.style.display = 'block';
            historyListDiv.style.display = 'none';
          } else {
            pinListDiv.style.display = 'none';
            historyListDiv.style.display = 'block';
          }
        });
      });

      // Î¨ºÍ±¥ Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
      function renderPinList() {
        pinListDiv.innerHTML = '';
        pins.forEach(pin => {
          const div = document.createElement('div');
          div.className = 'pinItem';
          div.dataset.id = pin.id;
          div.innerHTML = `
            <div class="pinEmoji">${pin.emoji || 'üìå'}</div>
            <div class="pinName">${pin.name}</div>
            <div class="pinStatus">${pin.comment ? 'ÏΩîÎ©òÌä∏ ÏûàÏùå' : ''}</div>
          `;
          div.addEventListener('click', () => {
            openEditModal(pin);
          });
          pinListDiv.appendChild(div);
        });
      }

      // ÌûàÏä§ÌÜ†Î¶¨ Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
      function renderHistory() {
        historyListDiv.innerHTML = '';
        history.forEach(h => {
          const div = document.createElement('div');
          div.className = 'historyItem';
          div.textContent = `[${new Date(h.time).toLocaleString()}] ${h.text}`;
          historyListDiv.appendChild(div);
        });
      }

      // ÌïÄ ÏÉùÏÑ±
      function createPin(x, y, pinData) {
        const pin = document.createElement('div');
        pin.className = 'pin';
        pin.style.left = `${x}px`;
        pin.style.top = `${y}px`;
        pin.style.backgroundColor = pinData.color || '#ff8c00';
        pin.textContent = pinData.emoji || 'üìå';
        pin.dataset.id = pinData.id;
        pin.dataset.name = pinData.name;
        pin.dataset.color = pinData.color;
        const style = document.createElement('style');
        style.textContent = `
          .pin[data-id="${pinData.id}"]::after {
            background-color: ${pinData.color};
        }`;
        document.head.appendChild(style);

        // ÎìúÎûòÍ∑∏ ÏãúÏûë ÏúÑÏπò
        let offsetX, offsetY;
        let dragging = false;

        pin.addEventListener('mousedown', (e) => {
          if (!isMovingPin) return;
          dragging = true;
          offsetX = e.clientX - pin.offsetLeft;
          offsetY = e.clientY - pin.offsetTop;
          pin.classList.add('dragging');
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!dragging) return;
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;

          // Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä Ï¢åÌëú Ï†úÌïú
          const rect = floorplanContainer.getBoundingClientRect();
          newX = Math.min(Math.max(0, newX), rect.width - pin.offsetWidth);
          newY = Math.min(Math.max(0, newY), rect.height - pin.offsetHeight);

          pin.style.left = `${newX}px`;
          pin.style.top = `${newY}px`;
        });

        document.addEventListener('mouseup', (e) => {
          if (!dragging) return;
          dragging = false;
          pin.classList.remove('dragging');

          // ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÄÏû•
          const id = pin.dataset.id;
          const idx = pins.findIndex(p => p.id === id);
          if (idx !== -1) {
            pins[idx].x = parseInt(pin.style.left);
            pins[idx].y = parseInt(pin.style.top);
            addHistory(`Î¨ºÍ±¥ "${pins[idx].name}" ÏúÑÏπò Î≥ÄÍ≤ΩÎê®.`);
            renderHistory();
            renderPinList();
          }
        });

        floorplanContainer.appendChild(pin);
      }

      // Î¨ºÍ±¥ Ï∂îÍ∞Ä Î≤ÑÌäº ÌÅ¥Î¶≠
      addPinBtn.addEventListener('click', () => {
        addPinPopup.style.display = 'flex';
        // Ï§ëÏïôÏóê ÎùÑÏö∞Í∏∞ (floorplan Ïª®ÌÖåÏù¥ÎÑà Í∏∞Ï§Ä)
        addPinPopup.style.left = (floorplanContainer.clientWidth / 2 - addPinPopup.clientWidth / 2) + 'px';
        addPinPopup.style.top = (floorplanContainer.clientHeight / 2 - addPinPopup.clientHeight / 2) + 'px';

        newPinNameInput.value = '';
        newPinEmojiInput.value = '';
        newPinColorSelect.value = '#ff8c00';
      });
      
      function reportPosition(x, y){
        fetch(`/items/${id}/move`, {
          method: 'post',
          headers: {
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({
            newX: x,
            newY: y,
          })
        },
        )
        .then(response => response.json())
        .then(data => {
          if(data.success) console.log(`Î¨ºÍ±¥ ${id} ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ: (${x}, ${y})`);
          else console.error(`Î¨ºÍ±¥ ${id} ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${data.error}`);
        })
      }

      // Î¨ºÍ±¥ Ï∂îÍ∞Ä ÌåùÏóÖÏóêÏÑú ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠
      confirmAddPinBtn.addEventListener('click', () => {
        const name = newPinNameInput.value.trim();
        const emoji = newPinEmojiInput.value.trim() || 'üìå';
        const color = newPinColorSelect.value;

        if (!name) {
          alert('Î¨ºÍ±¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
          return;
        }

        // Í∏∞Î≥∏ ÏúÑÏπò Ï§ëÏïô (floorplan Ï§ëÏïô)
        const x = floorplanContainer.clientWidth / 2 - 16;
        const y = floorplanContainer.clientHeight / 2 - 16;

        const id = Date.now().toString();

        const newPin = { id, name, emoji, color, comment: '', x, y };
        reportPosition(x, y);
        pins.push(newPin);
        createPin(x, y, newPin);
        renderPinList();
        addPinPopup.style.display = 'none';
        addHistory(`Î¨ºÍ±¥ "${name}" Ï∂îÍ∞ÄÎê®.`);
        renderHistory();
      });

      // Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞
      function openEditModal(pin) {
        selectedPin = pin;
        editPinName.value = pin.name;
        editPinEmoji.value = pin.emoji || '';
        editPinComment.value = pin.comment || '';
        editPinColor.value = pin.color || '#ff8c00';
        editModal.style.display = 'flex';
      }

      // Ìé∏Ïßë Î™®Îã¨ Ï†ÄÏû•
      savePinBtn.addEventListener('click', () => {
        if (!selectedPin) return;
        const name = editPinName.value.trim();
        const emoji = editPinEmoji.value.trim() || 'üìå';
        const comment = editPinComment.value.trim();
        const color = editPinColor.value;

        if (!name) {
          alert('Î¨ºÍ±¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
          return;
        }

        selectedPin.name = name;
        selectedPin.emoji = emoji;
        selectedPin.comment = comment;
        selectedPin.color = color;

        // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        updatePinOnMap(selectedPin);
        renderPinList();
        addHistory(`Î¨ºÍ±¥ "${name}" Ï†ïÎ≥¥ ÏàòÏ†ïÎê®.`);
        renderHistory();
        closeEditModal();
      });

      // Ìé∏Ïßë Î™®Îã¨ ÏÇ≠Ï†ú
      deletePinBtn.addEventListener('click', () => {
        if (!selectedPin) return;
        if (!confirm(`Ï†ïÎßê "${selectedPin.name}" ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

        // ÌïÄ Ï†úÍ±∞
        const idx = pins.findIndex(p => p.id === selectedPin.id);
        if (idx !== -1) {
          pins.splice(idx, 1);
        }

        // ÌôîÎ©¥ÏóêÏÑú Ï†úÍ±∞
        const domPin = floorplanContainer.querySelector(`.pin[data-id="${selectedPin.id}"]`);
        if (domPin) domPin.remove();

        renderPinList();
        addHistory(`Î¨ºÍ±¥ "${selectedPin.name}" ÏÇ≠Ï†úÎê®.`);
        renderHistory();
        closeEditModal();
      });

      cancelBtn.addEventListener('click', () => {
        closeEditModal();
      });

      function closeEditModal() {
        selectedPin = null;
        editModal.style.display = 'none';
      }

      // ÌôîÎ©¥ ÌïÄ ÏóÖÎç∞Ïù¥Ìä∏
      function updatePinOnMap(pinData) {
        const domPin = floorplanContainer.querySelector(`.pin[data-id="${pinData.id}"]`);
        if (!domPin) return;
        domPin.style.left = pinData.x + 'px';
        domPin.style.top = pinData.y + 'px';
        domPin.style.backgroundColor = pinData.color;
        domPin.textContent = pinData.emoji;
        reportPosition(pinData.x, pinData.y);
      }

      // ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
      function addHistory(text) {
        history.unshift({ time: Date.now(), text });
      }

      // Î¨ºÍ±¥ ÏòÆÍ∏∞Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ ÌÜ†Í∏Ä
      movePinBtn.addEventListener('click', () => {
        isMovingPin = !isMovingPin;
        movePinBtn.textContent = isMovingPin ? 'ÏòÆÍ∏∞Í∏∞ Ï§ë (ÌÅ¥Î¶≠ÌïòÏó¨ Ï¢ÖÎ£å)' : 'Î¨ºÍ±¥ ÏòÆÍ∏∞Í∏∞';
        if (!isMovingPin) {
          // ÎßàÏö∞Ïä§ Ïª§ÏÑú Í∏∞Î≥∏ÏúºÎ°ú
          floorplanContainer.style.cursor = 'default';
        } else {
          floorplanContainer.style.cursor = 'grab';
        }
      });

      // Ï¥àÍ∏∞ Î†åÎçîÎßÅ (ÏóÜÏùå)
      renderPinList();
      renderHistory();
    })();
  </script>
</body>

</html>
