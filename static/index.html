<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ì½•ì§‘ì–´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @font-face {
      font-family: 'Pretendard-Regular';
      src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
    }
    * {
      box-sizing: border-box;
    }
    :root {
      --brand-color: #FFB74D;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Pretendard-Regular', sans-serif;
      background: #fff;
      color: #333;
      user-select: none;
    }

    /* ì‹œì‘ í™”ë©´ */
    #startScreen {
      width: 400px;
      background: white;
      border-radius: 12px;
      padding: 30px 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      user-select: text;
    }

    #startScreen h1 {
      margin-bottom: 20px;
      font-size: 35px;
      font-weight: 800;
      color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    #startScreen h1 svg {
      width: 26px;
      height: 26px;
      fill: var(--brand-color);
    }

    #placeNameInput {
      background-color: #F0F0F0;
      width: 100%;
      padding: 10px 14px;
      font-size: 16px;
      border: none;
      border-radius: 20px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
      height: 50px;
    }

    #placeNameInput:focus {
      border-color: var(--brand-color);
      outline: none;
    }

    #uploadBtn {
      display: none;
    }

    #uploadLabel {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 50px;
      padding: 12px 0;
      font-size: 16px;
      background: var(--brand-color);
      border: none;
      border-radius: 20px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #uploadLabel:hover {
      background: var(--brand-color);
    }

    /* ë©”ì¸ í™”ë©´ ì „ì²´ ì»¨í…Œì´ë„ˆ */
    #mainApp {
      display: none;
      height: 100vh;
      width: 100vw;
      background: #fff8e1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* ì‚¬ì´ë“œë°” (ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸, íˆìŠ¤í† ë¦¬ ë“±) */
    #sidebar {
      width: 320px;
      background: var(--brand-color);
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      gap: 10px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      user-select: text;
    }

    #sidebar h2 {
      margin: 0 0 10px 0;
      font-weight: 700;
      font-size: 20px;
      color: #3e2723;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }

    #sidebar h2 svg {
      width: 18px;
      height: 18px;
      fill: #3e2723;
    }

    /* íƒ­ ë©”ë‰´ */
    #tabMenu {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabButton {
      flex: 1;
      padding: 8px 0;
      background: #fff3e0;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      color: #6d4c41;
      cursor: pointer;
      border: 2px solid transparent;
      transition: background-color 0.3s, border-color 0.3s;
      text-align: center;
      user-select: none;
    }

    .tabButton.active {
      background: white;
      border-color: #ff8c00;
      color: #e65100;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    #actionButtons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    button.actionBtn {
      flex: 1;
      background: #ffa726;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      padding: 10px 0;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    button.actionBtn:hover {
      background: #fb8c00;
    }

    button.actionBtn:disabled {
      background: #ffd180;
      cursor: default;
    }

    /* ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸ */
    #pinList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 10px 6px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
    }

    .pinItem {
      background: white;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s;
      user-select: none;
    }

    .pinItem:hover {
      background-color: #fff8e1;
    }

    .pinEmoji {
      font-size: 22px;
      user-select: none;
      width: 30px;
      text-align: center;
      flex-shrink: 0;
    }

    .pinName {
      flex: 1;
      font-weight: 600;
      font-size: 16px;
      color: #4e342e;
      user-select: text;
    }

    .pinStatus {
      font-size: 13px;
      color: #999;
      flex-shrink: 0;
      user-select: none;
    }

    /* íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ */
    #historyList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      color: #5d4037;
      user-select: none;
    }

    .historyItem {
      padding: 6px 8px;
      margin-bottom: 6px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* ë„ë©´ ì»¨í…Œì´ë„ˆ */
    #floorplan-container {
      flex: 1;
      position: relative;
      background: white;
      border-left: 1px solid #ddd;
      overflow: hidden;
      user-select: none;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #floorplan {
      max-width: 100%;
      max-height: 100%;
      user-drag: none;
      user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      transition: transform 0.2s ease-out;
      transform-origin: 0 0;
      display: block;
      position: relative;
    }

    /* í•€ */
    .pin {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ff8c00;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      border: 2.5px solid white;
      box-shadow: 0 0 7px rgba(255, 140, 0, 0.7);
      transition: box-shadow 0.2s;
      user-select: none;
      z-index: 10;
    }
    .pin:after {
      content: attr(data-name);
      white-space: nowrap;
      color: black;
      font-size: 15px;
      font-weight: 300;
      position: absolute;
      top: 120%;
      left: 50%;
      transform: translateX(-50%);
      display: block;
      padding: 4px 8px;
      text-align: center;
      border-radius: 5px;
      opacity: 0;
      transition: 0.5s;
    }

    .pin:hover::after {
      opacity: 1;
    }

    .pin.dragging {
      cursor: grabbing;
      box-shadow: 0 0 14px 4px rgba(255, 140, 0, 0.9);
      z-index: 9999;
    }

    /* ë„ë©´ ìœ„ ë¬¼ê±´ ì¶”ê°€ ì…ë ¥ ë°•ìŠ¤ */
    #addPinPopup {
      position: absolute;
      background: #fff3e0;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      padding: 15px 18px;
      width: 220px;
      user-select: none;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    #addPinPopup input[type=text] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
    }

    #addPinPopup select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    #addPinPopup button {
      background: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    #addPinPopup button:hover {
      background: #e65100;
    }

    /* í¸ì§‘ ëª¨ë‹¬ */
    #editModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      padding: 24px;
      width: 350px;
      z-index: 2000;
      display: none;
      flex-direction: column;
      user-select: none;
    }

    #editModal input,
    #editModal select,
    #editModal textarea {
      width: 100%;
      margin-bottom: 14px;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      outline: none;
    }

    #editModal textarea {
      resize: vertical;
      height: 80px;
    }

    #editModalButtons {
      display: flex;
      justify-content: space-between;
    }

    #savePinBtn,
    #deletePinBtn,
    #cancelBtn {
      padding: 12px 18px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      flex: 1;
      margin: 0 6px;
      transition: background-color 0.3s;
    }

    #savePinBtn {
      background-color: #4caf50;
      color: white;
    }

    #savePinBtn:hover {
      background-color: #388e3c;
    }

    #deletePinBtn {
      background-color: #f44336;
      color: white;
    }

    #deletePinBtn:hover {
      background-color: #d32f2f;
    }

    #cancelBtn {
      background-color: #9e9e9e;
      color: white;
    }

    #cancelBtn:hover {
      background-color: #616161;
    }
    
    #toggleSidebarBtn:hover {
      background-color: #ffa726;
    }

    /* ì‚¬ì´ë“œë°” ì ‘íŒ ìƒíƒœ */
    .sidebar-collapsed #sidebar {
      display: none;
    }

    .sidebar-collapsed #floorplan-container {
      flex: 1;
    }
    #toggleSidebarBtn {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 3000;
      background: #ffb74d;
      border: none;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      padding: 0;
      font-size: 22px;
      font-weight: bold;
      color: #3e2723;
      cursor: pointer;
      box-sizing: border-box;
      line-height: 36px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: left 0.3s ease, background-color 0.3s ease;
    }

  #mainApp.sidebar-visible #toggleSidebarBtn {
    /* ì‚¬ì´ë“œë°”ê°€ 320pxì´ë‹ˆê¹,
      ë²„íŠ¼ì„ ì‚¬ì´ë“œë°” ì˜¤ë¥¸ìª½ ëì— ë¶™ì´ë ¤ë©´ 320 - 36 - 8 (ì—¬ìœ ) = 276px */
    left: 276px;
  }

  #mainApp.sidebar-collapsed #toggleSidebarBtn {
    left: 16px;
  }

  #toggleSidebarBtn:hover {
    background-color: #ffa726;
  }

  #loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
  }
  #loading h2 {
      color: #FFB74D;
      margin-bottom: 30px;
  }
  #loading svg {
      width: 100px;
      height: 100px;
      animation: ani 3s linear infinite;
  }
  @keyframes ani {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }

    /* ìš°ì¸¡ ìƒë‹¨ ë¡œê·¸ì¸ ë²„íŠ¼ */
    #loginContainer {
      display: flex;
      flex-direction: row;
      justify-content: flex-end;
    }
    #loginBtn, #showRegisterBtn {
      padding: 6px 12px;
      font-size: 14px;
      background-color:#ffb74d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 998;
      margin: 5px;
    }
    #backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.4); /* â† ê²€ì •ìƒ‰ ë°˜íˆ¬ëª… */
      z-index: 999; /* loginPopupë³´ë‹¤ ë‚®ê²Œ! */
      display: none;
    }
    #loginPopup {
      display: none;
      position: fixed;
      top: 50%;
      right: 50%;
      transform: translate(50%, -50%);
      background-color: white;
      border: 1px solid #ccc;
      padding: 15px;
      width: 220px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      z-index: 1001;
    }
    #loginPopup input {
      width: 100%;
      margin-top: 5px;
      border: none;
      background-color: #F0F0F0;
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
    }
    #loginPopup button {
      width: 100%;
      padding: 8px;
      background-color: #ffb74d;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 5px;
    }
    #mainContainer {
      width: 100%;
      height: 100%;
      background-color: #f8f8f8;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #registerPopup {
      display: none;
      z-index: 1000;
      border-radius: 8px;
      flex-direction: column;
      z-index:1000;
      position:fixed; 
      top:50%; 
      left:50%; 
      transform:translate(-50%, -50%); 
      background:#fff;
      padding: 20px;
    }
    #registerPopup input {
      margin-top: 5px;
      border: none;
      background-color: #F0F0F0;
      padding: 10px;
      border-radius: 10px;
    }
    #registerPopup button {
      margin-top: 5px;
      background-color: var(--brand-color);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginContainer">
    <button id="loginBtn" type="button">ë¡œê·¸ì¸</button>
    <button id="showRegisterBtn" type="button">íšŒì›ê°€ì…</button> <!-- íšŒì›ê°€ì… íŒì—… ì—´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
  </div>
  <div id="backdrop"></div>
  <div id="loginPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>ë¡œê·¸ì¸</h3>  
    <input type="text" id="usernameInput" placeholder="ì‚¬ìš©ìëª… ì…ë ¥" />
    <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" /> <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
    <button id="loginConfirmBtn" type="button">í™•ì¸</button>
    <button id="loginCloseBtn" type="button">ë‹«ê¸°</button> <!-- íŒì—… ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€ -->
  </div>
  
  <div id="registerPopup">
    <h3>íšŒì›ê°€ì…</h3>
    <input type="text" id="regUsername" placeholder="ì‚¬ìš©ìëª…" />  
    <input type="password" id="regPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <input type="password" id="regPasswordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
    <button id="registerBtn" type="button">íšŒì›ê°€ì…</button>
    <button id="registerCloseBtn" type="button">ë‹«ê¸°</button>
    <div id="registerMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="startScreen">
    <h1>
      <img src="logo.png" width="32px" height="40px">
        <path
          d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
      </svg>
      ì½•ì§‘ì–´
    </h1>
    <input type="text" id="placeNameInput" placeholder="ì¥ì†Œ ì´ë¦„ ì…ë ¥" />
    <label for="uploadBtn" id="uploadLabel">ì‚¬ì§„ ì—…ë¡œë“œ</label>
    <input type="file" id="uploadBtn" accept="image/*" />
  </div>

  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading">
      <h2>Loading...</h2>
      <svg width="139" height="130" viewBox="0 0 139 130" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M109 20H120L139 60H122V130H17V60H0L16.5 20H89V0H109V20ZM29 88V100H42V88H29ZM47 88V100H59V88H47ZM29 83H42V70H29V83ZM47 83H59V70H47V83Z" fill="#FFB74D"/>
      </svg>            
  </div>

  <!-- ë©”ì¸ í™”ë©´ -->
  <div id="mainApp">
    <button id="toggleSidebarBtn">â˜°</button>
    <div id="sidebar">
      <!-- <h2>ğŸ  ì§‘</h2> -->
      <div id="tabMenu">
        <div class="tabButton active" data-tab="pinList">ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸</div>
        <div class="tabButton" data-tab="historyList">ì´ë™ íˆìŠ¤í† ë¦¬</div>
      </div>
      <div id="actionButtons">
        <button id="movePinBtn" class="actionBtn">ë¬¼ê±´ ì˜®ê¸°ê¸°</button>
        <button id="addPinBtn" class="actionBtn">ë¬¼ê±´ ì¶”ê°€</button>
      </div>
      <div id="pinList"></div>
      <div id="historyList" style="display:none;"></div>
    </div>
    <div id="floorplan-container">
      <img id="floorplan" src="" alt="ë„ë©´ ì´ë¯¸ì§€" draggable="false" />

      <!-- ë¬¼ê±´ ì¶”ê°€ íŒì—… -->
      <div id="addPinPopup">
        <input type="text" id="newPinName" placeholder="ë¬¼ê±´ ì´ë¦„" />
        <input type="text" id="newPinEmoji" placeholder="ì´ëª¨ì§€ (ì˜ˆ: ğŸ“Œ)" />
        <select id="newPinColor">
          <option value="#ff8c00">ì£¼í™©</option>
          <option value="#f44336">ë¹¨ê°•</option>
          <option value="#4caf50">ì´ˆë¡</option>
          <option value="#2196f3">íŒŒë‘</option>
          <option value="#9c27b0">ë³´ë¼</option>
          <option value="#ffeb3b">ë…¸ë‘</option>
        </select>
        <button id="confirmAddPinBtn">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- í¸ì§‘ ëª¨ë‹¬ -->
  <div id="editModal">
    <input type="text" id="editPinName" placeholder="ë¬¼ê±´ ì´ë¦„" />
    <input type="text" id="editPinEmoji" placeholder="ì´ëª¨ì§€ (ì˜ˆ: ğŸ“Œ)" />
    <textarea id="editPinComment" placeholder="ì½”ë©˜íŠ¸"></textarea>
    <select id="editPinColor">
      <option value="#ff8c00">ì£¼í™©</option>
      <option value="#f44336">ë¹¨ê°•</option>
      <option value="#4caf50">ì´ˆë¡</option>
      <option value="#2196f3">íŒŒë‘</option>
      <option value="#9c27b0">ë³´ë¼</option>
      <option value="#ffeb3b">ë…¸ë‘</option>
    </select>
    <div id="editModalButtons">
      <button id="savePinBtn">ì €ì¥</button>
      <button id="deletePinBtn">ì‚­ì œ</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>
  </div>

  <script>
    (() => {
      // --- ìƒíƒœ ë³€ìˆ˜ ---
      let currentUser = null;
      let authToken = null;
      let currentPlaceId = null;
      let pins = [];
      let history = [];
      let selectedPin = null;
      let isMovingPin = false;
    
      // --- DOM ìš”ì†Œ ---
      const startScreen = document.getElementById('startScreen');
      const placeNameInput = document.getElementById('placeNameInput');
      const uploadBtn = document.getElementById('uploadBtn');
      const mainApp = document.getElementById('mainApp');
      const floorplan = document.getElementById('floorplan');
      const floorplanContainer = document.getElementById('floorplan-container');
      const addPinBtn = document.getElementById('addPinBtn');
      const movePinBtn = document.getElementById('movePinBtn');
      const tabButtons = document.querySelectorAll('.tabButton');
      const pinListDiv = document.getElementById('pinList');
      const historyListDiv = document.getElementById('historyList');
      const addPinPopup = document.getElementById('addPinPopup');
      const newPinNameInput = document.getElementById('newPinName');
      const newPinEmojiInput = document.getElementById('newPinEmoji');
      const newPinColorSelect = document.getElementById('newPinColor');
      const confirmAddPinBtn = document.getElementById('confirmAddPinBtn');
      const editModal = document.getElementById('editModal');
      const editPinName = document.getElementById('editPinName');
      const editPinEmoji = document.getElementById('editPinEmoji');
      const editPinComment = document.getElementById('editPinComment');
      const editPinColor = document.getElementById('editPinColor');
      const savePinBtn = document.getElementById('savePinBtn');
      const deletePinBtn = document.getElementById('deletePinBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const loginBtn = document.getElementById('loginBtn');
      const loginCloseBtn = document.getElementById('loginCloseBtn');
      const loginPopup = document.getElementById('loginPopup');
      const loginConfirmBtn = document.getElementById('loginConfirmBtn');
      const usernameInput = document.getElementById('usernameInput');
      const passwordInput = document.getElementById('passwordInput');
      const showRegisterBtn = document.getElementById('showRegisterBtn');
      const registerPopup = document.getElementById('registerPopup');
      const registerCloseBtn = document.getElementById('registerCloseBtn');
      const registerBtn = document.getElementById('registerBtn');
      const regUsernameInput = document.getElementById('regUsername');
      const regPasswordInput = document.getElementById('regPassword');
      const regPasswordConfirmInput = document.getElementById('regPasswordConfirm');
      const registerMsg = document.getElementById('registerMsg');
      const loading = document.getElementById('loading');
      const backdrop = document.getElementById('backdrop');
    
      // --- ë¡œê·¸ì¸/íšŒì›ê°€ì…ì„ ìœ„í•œ API í˜¸ì¶œ ë˜í¼ ---
      function apiFetch(url, options = {}) {
        options.headers = options.headers || {};
        if (authToken) {
          options.headers['Authorization'] = `Bearer ${authToken}`;
        }
        return fetch(url, options);
      }
    
      // --- ë¡œê·¸ì¸ ìƒíƒœ UI ì²˜ë¦¬ ---
      function setLoggedIn(user) {
        currentUser = user;
        loginBtn.textContent = `${currentUser} ë‹˜ (ë¡œê·¸ì•„ì›ƒ)`;
        loginPopup.style.display = 'none';
        registerPopup.style.display = 'none';
        loading.style.display = 'none';
      }
      function setLoggedOut() {
        currentUser = null;
        authToken = null;
        currentPlaceId = null;
        pins = [];
        history = [];
        loginBtn.textContent = 'ë¡œê·¸ì¸';
        init(); // ë‹¤ì‹œ ì‹œì‘ í™”ë©´ìœ¼ë¡œ
        clearPinsFromMap();
        renderPinList();
        renderHistory();
      }
    
      // --- ì´ˆê¸° í™”ë©´/ì•± í™”ë©´ í† ê¸€ ---
      function init() {
        startScreen.style.display = 'block';
        mainApp.style.display = 'none';
        loading.style.display = 'none';
        mainApp.classList.add('sidebar-visible');
        console.log('startScreen', startScreen);
        console.log('mainApp', mainApp);
        console.log('loading', loading);
      }
      init();
    
      // --- ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ---
      loginBtn.addEventListener('click', () => {
        if (authToken) {
          if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) setLoggedOut();
        } else {
          loginPopup.style.display = 'block';
          backdrop.style.display = 'block';
          registerPopup.style.display = 'none';
        }
      });

      loginCloseBtn.addEventListener('click', () => {
        loginPopup.style.display = 'none';
        backdrop.style.display = 'none';
        usernameInput.value = '';
        passwordInput.value = '';
      })
    
      // --- ë¡œê·¸ì¸ ì œì¶œ ---
      loginConfirmBtn.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        if (!username || !password) {
          alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (res.ok && data.token) {
            authToken = data.token;
            setLoggedIn(username);
            alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${username}ë‹˜!`);
          } else {
            alert(data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
          }
          backdrop.style.display = 'none';
        } catch {
          alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
        }
      });
    
      // --- íšŒì›ê°€ì… íŒì—… ì—´ê¸°/ë‹«ê¸° ---
      showRegisterBtn.addEventListener('click', () => {
        registerPopup.style.display = 'flex';
        backdrop.style.display= 'block';
        loginPopup.style.display = 'none';
        registerMsg.textContent = '';
      });
      registerCloseBtn.addEventListener('click', () => {
        registerPopup.style.display = 'none';
        backdrop.style.display= 'none';
        registerMsg.textContent = '';
      });
    
      // --- íšŒì›ê°€ì… ì œì¶œ ---
      registerBtn.addEventListener('click', async () => {
        const username = regUsernameInput.value.trim();
        const password = regPasswordInput.value;
        const passwordConfirm = regPasswordConfirmInput.value;
        if (!username || !password || !passwordConfirm) {
          registerMsg.style.color = 'red';
          registerMsg.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          return;
        }
        if (password !== passwordConfirm) {
          registerMsg.style.color = 'red';
          registerMsg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          return;
        }
        try {
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (res.ok) {
            registerMsg.style.color = 'green';
            registerMsg.textContent = 'íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
          } else {
            registerMsg.style.color = 'red';
            registerMsg.textContent = data.error || 'íšŒì›ê°€ì… ì‹¤íŒ¨';
          }
          backdrop.style.display = 'none';
        } catch {
          registerMsg.style.color = 'red';
          registerMsg.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
        }
      });
    
      // --- ì¥ì†Œ ì—…ë¡œë“œ (POST /api/places) ---
      uploadBtn.addEventListener('change', async (e) => {
        if (!authToken) {
          alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
          uploadBtn.value = '';
          return;
        }
        const file = e.target.files[0];
        const placeName = placeNameInput.value.trim();
        if (!placeName) {
          alert('ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
          uploadBtn.value = '';
          return;
        }
        if (!file) {
          alert('ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }
        try {
          const formData = new FormData();
          formData.append('name', placeName);
          formData.append('image', file);
          loading.style.display = 'flex';
          const res = await apiFetch('/api/places', {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (res.ok && data._id) {
            currentPlaceId = data._id;
            // loading.style.display = 'flex';
            floorplan.onload = async () => {
              // ì´ë¯¸ì§€ê°€ í™”ë©´ì— ë‹¤ ëœ¬ ë’¤ ì‹¤í–‰ë¨
              loading.style.display = 'none';
              startScreen.style.display = 'none';
              mainApp.style.display = 'flex';

              document.title = `ì½•ì§‘ì–´ - ${placeName}`;
              const h2 = document.createElement('h2');
              h2.textContent = placeName;
              const tabmenu = document.querySelector('#tabMenu');
              document.querySelector('#sidebar').insertBefore(h2, tabmenu);

              await loadPins();
              await loadHistory();
            };
            floorplan.src = URL.createObjectURL(file);
            startScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            document.title = `ì½•ì§‘ì–´ - ${placeName}`;
            const h2 = document.createElement('h2');
            h2.textContent = placeName;
            const tabmenu = document.querySelector('#tabMenu');
            document.querySelector('#sidebar').insertBefore(h2, tabmenu);
    
            await loadPins();
            await loadHistory();
          } else {
            alert(data.error || 'ì¥ì†Œ ìƒì„± ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        }
      });
    
      // --- í•€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ---
      async function loadPins() {
        if (!currentPlaceId) return;
        try {
          const res = await apiFetch(`/api/places/${currentPlaceId}/pins`);
          const arr = await res.json();
          if (res.ok) {
            pins = arr.map(p => ({
              id: p._id, name: p.name, emoji: p.emoji,
              color: p.color, x: p.x, y: p.y, comment: p.comment
            }));
            clearPinsFromMap();
            pins.forEach(p => createPin(p.x, p.y, p));
            renderPinList();
          }
        } catch {
          alert('í•€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜');
        }
      }
    
      // --- íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ---
      async function loadHistory() {
        if (!currentPlaceId) return;
        try {
          const res = await apiFetch(`/api/places/${currentPlaceId}/history`);
          const arr = await res.json();
          if (res.ok) {
            history = arr.map(h => ({
              time: new Date(h.time).getTime(),
              text: `ë¬¼ê±´ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
            }));
            renderHistory();
          }
        } catch {
          alert('íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
        }
      }
    
      // --- í•€ í™”ë©´ì—ì„œ ëª¨ë‘ ì§€ìš°ê¸° ---
      function clearPinsFromMap() {
        floorplanContainer.querySelectorAll('.pin').forEach(el => el.remove());
      }
    
      // --- í•€ ìƒì„± & ë“œë˜ê·¸/ì €ì¥ ë¡œì§ ---
      function createPin(x, y, pinData) {
        const pin = document.createElement('div');
        pin.className = 'pin';
        pin.style.left = `${x}px`;
        pin.style.top = `${y}px`;
        pin.style.backgroundColor = pinData.color || '#ff8c00';
        pin.textContent = pinData.emoji || 'ğŸ“Œ';
        pin.dataset.id = pinData.id;
    
        let offsetX, offsetY, dragging = false;
    
        pin.addEventListener('mousedown', e => {
          if (!isMovingPin) return;
          dragging = true;
          offsetX = e.clientX - pin.offsetLeft;
          offsetY = e.clientY - pin.offsetTop;
          pin.classList.add('dragging');
          e.preventDefault();
        });
        document.addEventListener('mousemove', e => {
          if (!dragging) return;
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;
          const rect = floorplanContainer.getBoundingClientRect();
          newX = Math.min(Math.max(0, newX), rect.width - pin.offsetWidth);
          newY = Math.min(Math.max(0, newY), rect.height - pin.offsetHeight);
          pin.style.left = `${newX}px`;
          pin.style.top = `${newY}px`;
        });
        document.addEventListener('mouseup', async e => {
          if (!dragging) return;
          dragging = false;
          pin.classList.remove('dragging');
          const id = pin.dataset.id;
          const idx = pins.findIndex(p => p.id === id);
          if (idx === -1) return;
          pins[idx].x = parseInt(pin.style.left);
          pins[idx].y = parseInt(pin.style.top);
          try {
            // í•€ ìœ„ì¹˜ ìˆ˜ì • API
            await apiFetch(`/api/pins/${id}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ x: pins[idx].x, y: pins[idx].y })
            });
            // íˆìŠ¤í† ë¦¬ ìƒì„± API
            await apiFetch(`/api/places/${currentPlaceId}/history`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ pin_id: id, x: pins[idx].x, y: pins[idx].y })
            });
            addHistory(`ë¬¼ê±´ "${pins[idx].name}" ìœ„ì¹˜ ë³€ê²½ë¨.`);
            renderHistory();
            renderPinList();
          } catch {
            alert('ìœ„ì¹˜ ì €ì¥ ì‹¤íŒ¨');
          }
        });
    
        floorplanContainer.appendChild(pin);
      }
    
      // --- ë¬¼ê±´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ---
      function renderPinList() {
        pinListDiv.innerHTML = '';
        pins.forEach(pin => {
          const div = document.createElement('div');
          div.className = 'pinItem';
          div.dataset.id = pin.id;
          div.innerHTML = `
            <div class="pinEmoji">${pin.emoji||'ğŸ“Œ'}</div>
            <div class="pinName">${pin.name}</div>
            <div class="pinStatus">${pin.comment ? 'ì½”ë©˜íŠ¸ ìˆìŒ':''}</div>`;
          div.addEventListener('click', () => openEditModal(pin));
          pinListDiv.appendChild(div);
        });
      }
    
      // --- íˆìŠ¤í† ë¦¬ ë Œë”ë§ ---
      function renderHistory() {
        historyListDiv.innerHTML = '';
        history.forEach(h => {
          const div = document.createElement('div');
          div.className = 'historyItem';
          div.textContent = `[${new Date(h.time).toLocaleString()}] ${h.text}`;
          historyListDiv.appendChild(div);
        });
      }
    
      // --- ë¬¼ê±´ ì¶”ê°€ íŒì—… & API í˜¸ì¶œ ---
      addPinBtn.addEventListener('click', () => {
        if (!authToken) { alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.'); return; }
        addPinPopup.style.display = 'flex';
        addPinPopup.style.left = (floorplanContainer.clientWidth/2 - addPinPopup.clientWidth/2) + 'px';
        addPinPopup.style.top = (floorplanContainer.clientHeight/2 - addPinPopup.clientHeight/2) + 'px';
        newPinNameInput.value = '';
        newPinEmojiInput.value = '';
        newPinColorSelect.value = '#ff8c00';
      });
      confirmAddPinBtn.addEventListener('click', async () => {
        const name = newPinNameInput.value.trim();
        const emoji = newPinEmojiInput.value.trim() || '';
        const color = newPinColorSelect.value;
        if (!name) { alert('ë¬¼ê±´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if (!currentPlaceId) { alert('ì¥ì†Œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
        const x = floorplanContainer.clientWidth/2 - 16;
        const y = floorplanContainer.clientHeight/2 - 16;
        try {
          const res = await apiFetch(`/api/places/${currentPlaceId}/pins`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, emoji, color, x, y })
          });
          const data = await res.json();
          if (res.ok) {
            const p = { id: data._id, name:data.name, emoji:data.emoji, color:data.color, x:data.x, y:data.y, comment:data.comment };
            pins.push(p);
            createPin(p.x, p.y, p);
            renderPinList();
            addPinPopup.style.display = 'none';
            addHistory(`ë¬¼ê±´ "${name}" ì¶”ê°€ë¨.`);
            renderHistory();
          } else {
            alert(data.error||'ì¶”ê°€ ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì˜¤ë¥˜');
        }
      });
    
      // --- í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°/ì €ì¥/ì‚­ì œ ---
      function openEditModal(pin) {
        selectedPin = pin;
        editPinName.value = pin.name;
        editPinEmoji.value = pin.emoji||'';
        editPinComment.value = pin.comment||'';
        editPinColor.value = pin.color||'#ff8c00';
        editModal.style.display = 'flex';
      }
      savePinBtn.addEventListener('click', async () => {
        if (!selectedPin) return;
        const name = editPinName.value.trim();
        const emoji = editPinEmoji.value.trim()||'';
        const comment = editPinComment.value.trim();
        const color = editPinColor.value;
        if (!name) { alert('ë¬¼ê±´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        try {
          const res = await apiFetch(`/api/pins/${selectedPin.id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name, emoji, comment, color })
          });
          if (res.ok) {
            Object.assign(selectedPin, { name, emoji, comment, color });
            updatePinOnMap(selectedPin);
            renderPinList();
            addHistory(`ë¬¼ê±´ "${name}" ì •ë³´ ìˆ˜ì •ë¨.`);
            renderHistory();
            closeEditModal();
          } else {
            const err = await res.json();
            alert(err.error||'ìˆ˜ì • ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        }
      });
      deletePinBtn.addEventListener('click', async () => {
        if (!selectedPin) return;
        if (!confirm(`ì •ë§ "${selectedPin.name}" ì‚­ì œ?`)) return;
        try {
          const res = await apiFetch(`/api/pins/${selectedPin.id}`, { method:'DELETE' });
          if (res.ok) {
            pins = pins.filter(p=>p.id!==selectedPin.id);
            document.querySelector(`.pin[data-id="${selectedPin.id}"]`)?.remove();
            renderPinList();
            addHistory(`ë¬¼ê±´ "${selectedPin.name}" ì‚­ì œë¨.`);
            renderHistory();
            closeEditModal();
          } else {
            const err = await res.json();
            alert(err.error||'ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch {
          alert('ì„œë²„ ì˜¤ë¥˜');
        }
      });
      cancelBtn.addEventListener('click', closeEditModal);
      function closeEditModal() {
        selectedPin = null;
        editModal.style.display = 'none';
      }
      function updatePinOnMap(pin) {
        const el = floorplanContainer.querySelector(`.pin[data-id="${pin.id}"]`);
        if (!el) return;
        el.style.left = pin.x + 'px';
        el.style.top = pin.y + 'px';
        el.style.backgroundColor = pin.color;
        el.textContent = pin.emoji;
      }
    
      // --- íˆìŠ¤í† ë¦¬ ë¡œì»¬ ì¶”ê°€ ---
      function addHistory(text) {
        history.unshift({ time: Date.now(), text });
      }
    
      // --- ë¬¼ê±´ ì˜®ê¸°ê¸° í† ê¸€ ---
      movePinBtn.addEventListener('click', () => {
        isMovingPin = !isMovingPin;
        movePinBtn.textContent = isMovingPin ? 'ì˜®ê¸°ê¸° ì¤‘ (í´ë¦­í•˜ì—¬ ì¢…ë£Œ)' : 'ë¬¼ê±´ ì˜®ê¸°ê¸°';
        floorplanContainer.style.cursor = isMovingPin ? 'grab' : 'default';
      });
    
      // --- íƒ­ ì „í™˜ ---
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          tabButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          if (btn.dataset.tab==='pinList') {
            pinListDiv.style.display='block';
            historyListDiv.style.display='none';
          } else {
            pinListDiv.style.display='none';
            historyListDiv.style.display='block';
          }
        });
      });
    
    })();
    </script>
</body>

</html>