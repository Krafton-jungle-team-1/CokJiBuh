<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>콕집어 도면 편집기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Arial', sans-serif;
      background: #222;
      color: #333;
      user-select: none;
    }

    /* 시작 화면 */
    #startScreen {
      width: 400px;
      background: white;
      border-radius: 12px;
      padding: 30px 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      user-select: text;
    }

    #startScreen h1 {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 700;
      color: #ff8c00;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    #startScreen h1 svg {
      width: 26px;
      height: 26px;
      fill: #ff8c00;
    }

    #placeNameInput {
      width: 100%;
      padding: 10px 14px;
      font-size: 16px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    #placeNameInput:focus {
      border-color: #ff8c00;
      outline: none;
    }

    #uploadBtn {
      width: 100%;
      padding: 12px 0;
      font-size: 16px;
      background: #ffb74d;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #uploadBtn:hover {
      background: #ffa726;
    }

    /* 메인 화면 전체 컨테이너 */
    #mainApp {
      display: none;
      height: 100vh;
      width: 100vw;
      background: #fff8e1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* 사이드바 (물건 리스트, 히스토리 등) */
    #sidebar {
      width: 320px;
      background: #ffb74d;
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      gap: 10px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      user-select: text;
    }

    #sidebar h2 {
      margin: 0 0 10px 0;
      font-weight: 700;
      font-size: 20px;
      color: #3e2723;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }

    #sidebar h2 svg {
      width: 18px;
      height: 18px;
      fill: #3e2723;
    }

    /* 탭 메뉴 */
    #tabMenu {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tabButton {
      flex: 1;
      padding: 8px 0;
      background: #fff3e0;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      color: #6d4c41;
      cursor: pointer;
      border: 2px solid transparent;
      transition: background-color 0.3s, border-color 0.3s;
      text-align: center;
      user-select: none;
    }

    .tabButton.active {
      background: white;
      border-color: #ff8c00;
      color: #e65100;
    }

    /* 버튼 그룹 */
    #actionButtons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    button.actionBtn {
      flex: 1;
      background: #ffa726;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      padding: 10px 0;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    button.actionBtn:hover {
      background: #fb8c00;
    }

    button.actionBtn:disabled {
      background: #ffd180;
      cursor: default;
    }

    /* 물건 리스트 */
    #pinList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 10px 6px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
    }

    .pinItem {
      background: white;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.2s;
      user-select: none;
    }

    .pinItem:hover {
      background-color: #fff8e1;
    }

    .pinEmoji {
      font-size: 22px;
      user-select: none;
      width: 30px;
      text-align: center;
      flex-shrink: 0;
    }

    .pinName {
      flex: 1;
      font-weight: 600;
      font-size: 16px;
      color: #4e342e;
      user-select: text;
    }

    .pinStatus {
      font-size: 13px;
      color: #999;
      flex-shrink: 0;
      user-select: none;
    }

    /* 히스토리 리스트 */
    #historyList {
      flex: 1;
      overflow-y: auto;
      background: #fff3e0;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      color: #5d4037;
      user-select: none;
    }

    .historyItem {
      padding: 6px 8px;
      margin-bottom: 6px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* 도면 컨테이너 */
    #floorplan-container {
      flex: 1;
      position: relative;
      background: white;
      border-left: 1px solid #ddd;
      overflow: hidden;
      user-select: none;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #floorplan {
      max-width: 100%;
      max-height: 100%;
      user-drag: none;
      user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      transition: transform 0.2s ease-out;
      transform-origin: 0 0;
      display: block;
      position: relative;
    }

    /* 핀 */
    .pin {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ff8c00;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      border: 2.5px solid white;
      box-shadow: 0 0 7px rgba(255, 140, 0, 0.7);
      transition: box-shadow 0.2s;
      user-select: none;
      z-index: 10;
    }

    .pin.dragging {
      cursor: grabbing;
      box-shadow: 0 0 14px 4px rgba(255, 140, 0, 0.9);
      z-index: 9999;
    }

    /* 도면 위 물건 추가 입력 박스 */
    #addPinPopup {
      position: absolute;
      background: #fff3e0;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      padding: 15px 18px;
      width: 220px;
      user-select: none;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    #addPinPopup input[type=text] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
    }

    #addPinPopup select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0a500;
      font-size: 15px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    #addPinPopup button {
      background: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      padding: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

    #addPinPopup button:hover {
      background: #e65100;
    }

    /* 편집 모달 */
    #editModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      padding: 24px;
      width: 350px;
      z-index: 2000;
      display: none;
      flex-direction: column;
      user-select: none;
    }

    #editModal input,
    #editModal select,
    #editModal textarea {
      width: 100%;
      margin-bottom: 14px;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
      outline: none;
    }

    #editModal textarea {
      resize: vertical;
      height: 80px;
    }

    #editModalButtons {
      display: flex;
      justify-content: space-between;
    }

    #savePinBtn,
    #deletePinBtn,
    #cancelBtn {
      padding: 12px 18px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      flex: 1;
      margin: 0 6px;
      transition: background-color 0.3s;
    }

    #savePinBtn {
      background-color: #4caf50;
      color: white;
    }

    #savePinBtn:hover {
      background-color: #388e3c;
    }

    #deletePinBtn {
      background-color: #f44336;
      color: white;
    }

    #deletePinBtn:hover {
      background-color: #d32f2f;
    }

    #cancelBtn {
      background-color: #9e9e9e;
      color: white;
    }

    #cancelBtn:hover {
      background-color: #616161;
    }

  #toggleSidebarBtn:hover {
    background-color: #ffa726;
  }

  /* 사이드바 접힌 상태 */
  .sidebar-collapsed #sidebar {
    display: none;
  }

  .sidebar-collapsed #floorplan-container {
    flex: 1;
  }
#toggleSidebarBtn {
  position: fixed;
  top: 16px;
  left: 16px;
  z-index: 3000;
  background: #ffb74d;
  border: none;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  padding: 0;
  font-size: 22px;
  font-weight: bold;
  color: #3e2723;
  cursor: pointer;
  box-sizing: border-box;
  line-height: 36px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: left 0.3s ease, background-color 0.3s ease;
}

#mainApp.sidebar-visible #toggleSidebarBtn {
  /* 사이드바가 320px이니깐, 버튼을 사이드바 오른쪽 끝에 붙이려면 320 - 36 - 8 (여유) = 276px */
  left: 276px;
}

#mainApp.sidebar-collapsed #toggleSidebarBtn {
  left: 16px;
}

#toggleSidebarBtn:hover {
  background-color: #ffa726;
}
   body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* 우측 상단 로그인 버튼 */
    #loginBtn {
      position: fixed;
      top: 10px;
      right: 20px;
      padding: 6px 12px;
      font-size: 14px;
      background-color:#ffb74d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }

   #loginPopup {
  display: none;
  position: fixed;
  top: 50px;
  right: 20px;
  background-color: white;
  border: 1px solid #ccc;
  padding: 15px;
  width: 220px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
  z-index: 1001;
}

    #loginPopup input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #loginPopup button {
      width: 100%;
      padding: 8px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #mainContainer {
      width: 100%;
      height: 100%;
      background-color: #f8f8f8;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body>
<button id="loginBtn" type="button">로그인</button>
<button id="showRegisterBtn" type="button">회원가입</button> <!-- 회원가입 팝업 열기 버튼 추가 -->

<div id="loginPopup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
  <h3>로그인</h3>
  <input type="text" id="usernameInput" placeholder="사용자명 입력" />
  <input type="password" id="passwordInput" placeholder="비밀번호 입력" /> <!-- 비밀번호 입력 필드 추가 -->
  <button id="loginConfirmBtn" type="button">확인</button>
  <button id="loginCloseBtn" type="button">닫기</button> <!-- 팝업 닫기 버튼 추가 -->
</div>

<div id="registerPopup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
  <input type="text" id="regUsername" placeholder="사용자명" />
  <input type="password" id="regPassword" placeholder="비밀번호" />
  <input type="password" id="regPasswordConfirm" placeholder="비밀번호 확인" />
  <button id="registerBtn" type="button">회원가입</button>
  <button id="registerCloseBtn" type="button">닫기</button>
  <div id="registerMsg" style="color:red; margin-top:10px;"></div>
</div>

  <!-- 나머지 기존 화면 -->
  <div id="startScreen">
  <!-- 시작 화면 -->
  <div id="startScreen">
    <h1>
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
      </svg>
      콕집어
    </h1>
    <input type="text" id="placeNameInput" placeholder="장소 이름 입력" />
    <input type="file" id="uploadBtn" accept="image/*" />
  </div>

  <!-- 메인 화면 -->
 

  <div id="mainApp">
     <button id="toggleSidebarBtn">☰</button>
    <div id="sidebar">
      <h2>🏠 집</h2>
      <div id="tabMenu">
        <div class="tabButton active" data-tab="pinList">물건 리스트</div>
        <div class="tabButton" data-tab="historyList">이동 히스토리</div>
      </div>
      <div id="actionButtons">
        <button id="movePinBtn" class="actionBtn">물건 옮기기</button>
        <button id="addPinBtn" class="actionBtn">물건 추가</button>
      </div>
      <div id="pinList"></div>
      <div id="historyList" style="display:none;"></div>
    </div>
    <div id="floorplan-container">
      <img id="floorplan" src="" alt="도면 이미지" draggable="false" />

      <!-- 물건 추가 팝업 -->
      <div id="addPinPopup">
        <input type="text" id="newPinName" placeholder="물건 이름" />
        <input type="text" id="newPinEmoji" placeholder="이모지 (예: 📌)" />
        <select id="newPinColor">
          <option value="#ff8c00">주황</option>
          <option value="#f44336">빨강</option>
          <option value="#4caf50">초록</option>
          <option value="#2196f3">파랑</option>
          <option value="#9c27b0">보라</option>
          <option value="#ffeb3b">노랑</option>
        </select>
        <button id="confirmAddPinBtn">추가</button>
      </div>
    </div>
  </div>

  <!-- 편집 모달 -->
  <div id="editModal">
    <input type="text" id="editPinName" placeholder="물건 이름" />
    <input type="text" id="editPinEmoji" placeholder="이모지 (예: 📌)" />
    <textarea id="editPinComment" placeholder="코멘트"></textarea>
    <select id="editPinColor">
      <option value="#ff8c00">주황</option>
      <option value="#f44336">빨강</option>
      <option value="#4caf50">초록</option>
      <option value="#2196f3">파랑</option>
      <option value="#9c27b0">보라</option>
      <option value="#ffeb3b">노랑</option>
    </select>
    <div id="editModalButtons">
      <button id="savePinBtn">저장</button>
      <button id="deletePinBtn">삭제</button>
      <button id="cancelBtn">취소</button>
    </div>
  </div>

 <script>
(() => {
  let currentUser = null;
  let authToken = null;

  // --- DOM 요소들 ---
  const startScreen = document.getElementById('startScreen');
  const placeNameInput = document.getElementById('placeNameInput');
  const uploadBtn = document.getElementById('uploadBtn');

  const mainApp = document.getElementById('mainApp');
  const floorplan = document.getElementById('floorplan');
  const floorplanContainer = document.getElementById('floorplan-container');

  const addPinBtn = document.getElementById('addPinBtn');
  const movePinBtn = document.getElementById('movePinBtn');

  const tabButtons = document.querySelectorAll('.tabButton');
  const pinListDiv = document.getElementById('pinList');
  const historyListDiv = document.getElementById('historyList');

  const addPinPopup = document.getElementById('addPinPopup');
  const newPinNameInput = document.getElementById('newPinName');
  const newPinEmojiInput = document.getElementById('newPinEmoji');
  const newPinColorSelect = document.getElementById('newPinColor');
  const confirmAddPinBtn = document.getElementById('confirmAddPinBtn');

  const editModal = document.getElementById('editModal');
  const editPinName = document.getElementById('editPinName');
  const editPinEmoji = document.getElementById('editPinEmoji');
  const editPinComment = document.getElementById('editPinComment');
  const editPinColor = document.getElementById('editPinColor');
  const savePinBtn = document.getElementById('savePinBtn');
  const deletePinBtn = document.getElementById('deletePinBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  const loginBtn = document.getElementById('loginBtn');
  const loginPopup = document.getElementById('loginPopup');
  const loginConfirmBtn = document.getElementById('loginConfirmBtn');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput'); // 로그인 비번 입력필드

  const showRegisterBtn = document.getElementById('showRegisterBtn');
  const registerPopup = document.getElementById('registerPopup');
  const registerCloseBtn = document.getElementById('registerCloseBtn');
  const registerBtn = document.getElementById('registerBtn');
  const regUsernameInput = document.getElementById('regUsername');
  const regPasswordInput = document.getElementById('regPassword');
  const regPasswordConfirmInput = document.getElementById('regPasswordConfirm');
  const registerMsg = document.getElementById('registerMsg');

  // 상태 변수
  let pins = [];
  let history = [];
  let selectedPin = null;
  let isMovingPin = false;
  let currentPlaceId = null;

  // --- 헬퍼: API 호출에 토큰 헤더 자동 포함 ---
  function apiFetch(url, options = {}) {
    options.headers = options.headers || {};
    if (authToken) {
      options.headers['Authorization'] = `Bearer ${authToken}`;
    }
    return fetch(url, options);
  }

  // --- 로그인/로그아웃 UI 처리 ---
  function setLoggedIn(user) {
    currentUser = user;
    loginBtn.textContent = `${currentUser} 님 (로그아웃)`;
    loginPopup.style.display = 'none';
    registerPopup.style.display = 'none';
  }
  function setLoggedOut() {
    currentUser = null;
    authToken = null;
    currentPlaceId = null;
    pins = [];
    history = [];
    loginBtn.textContent = '로그인';
    startScreen.style.display = 'block';
    mainApp.style.display = 'none';
    floorplan.src = '';
    placeNameInput.value = '';
    clearPinsFromMap();
    renderPinList();
    renderHistory();
  }

  // --- 로그인 버튼 클릭 (로그인 팝업 토글 or 로그아웃) ---
  loginBtn.addEventListener('click', () => {
    if (authToken) {
      if (confirm('로그아웃 하시겠습니까?')) {
        setLoggedOut();
      }
    } else {
      loginPopup.style.display = loginPopup.style.display === 'block' ? 'none' : 'block';
      registerPopup.style.display = 'none';
    }
  });

  // 로그인 확인 버튼 클릭
  loginConfirmBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) {
      alert('아이디와 비밀번호를 입력해주세요.');
      return;
    }
    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });
      const data = await res.json();
      if (res.ok && data.token) {
        authToken = data.token;
        setLoggedIn(username);
        alert(`환영합니다, ${username}님!`);
      } else {
        alert(data.error || '로그인 실패');
      }
    } catch (e) {
      alert('서버 연결 오류');
    }
  });

  // 회원가입 팝업 열기 버튼
  showRegisterBtn.addEventListener('click', () => {
    registerPopup.style.display = 'block';
    loginPopup.style.display = 'none';
    registerMsg.textContent = '';
  });
  // 회원가입 팝업 닫기 버튼
  registerCloseBtn.addEventListener('click', () => {
    registerPopup.style.display = 'none';
    registerMsg.textContent = '';
  });
  // 회원가입 버튼 클릭
  registerBtn.addEventListener('click', async () => {
    const username = regUsernameInput.value.trim();
    const password = regPasswordInput.value;
    const passwordConfirm = regPasswordConfirmInput.value;
    if (!username || !password || !passwordConfirm) {
      registerMsg.style.color = 'red';
      registerMsg.textContent = '모든 항목을 입력하세요.';
      return;
    }
    if (password !== passwordConfirm) {
      registerMsg.style.color = 'red';
      registerMsg.textContent = '비밀번호가 일치하지 않습니다.';
      return;
    }
    try {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });
      const data = await res.json();
      if (res.ok) {
        registerMsg.style.color = 'green';
        registerMsg.textContent = '회원가입 성공! 로그인해주세요.';
      } else {
        registerMsg.style.color = 'red';
        registerMsg.textContent = data.error || '회원가입 실패';
      }
    } catch (e) {
      registerMsg.style.color = 'red';
      registerMsg.textContent = '서버 연결 실패';
    }
  });

  // --- 업로드 버튼 변경 이벤트 (장소 생성 API 호출) ---
  uploadBtn.addEventListener('change', async (e) => {
    if (!authToken) {
      alert('로그인 후 이용해주세요.');
      uploadBtn.value = '';
      return;
    }
    const file = e.target.files[0];
    const placeName = placeNameInput.value.trim();
    if (!placeName) {
      alert('장소 이름을 입력해주세요!');
      uploadBtn.value = '';
      return;
    }
    if (!file) {
      alert('사진을 선택해주세요!');
      return;
    }
    try {
      const formData = new FormData();
      formData.append('name', placeName);
      formData.append('image', file);

      const res = await apiFetch('/api/places', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (res.ok && data._id) {
        currentPlaceId = data._id;
        // 이미지 보여주기
        floorplan.src = URL.createObjectURL(file);

        startScreen.style.display = 'none';
        mainApp.style.display = 'flex';
        document.title = `콕집어 - ${placeName}`;
        const sidebarTitle = document.getElementById('sidebarTitle') || document.querySelector('#sidebar h2');
        if (sidebarTitle) sidebarTitle.textContent = placeName;

        // 장소에 맞는 데이터 불러오기
        await loadPins();
        await loadHistory();
      } else {
        alert(data.error || '장소 생성 실패');
      }
    } catch (e) {
      alert('서버 연결 실패');
    }
  });

  // --- 장소에 해당하는 핀 불러오기 ---
  async function loadPins() {
    if (!currentPlaceId) return;
    try {
      const res = await apiFetch(`/api/places/${currentPlaceId}/pins`);
      const data = await res.json();
      if (res.ok) {
        pins = data.map(p => ({
          id: p._id,
          name: p.name,
          emoji: p.emoji,
          color: p.color,
          x: p.x,
          y: p.y,
          comment: p.comment,
        }));
        clearPinsFromMap();
        pins.forEach(p => createPin(p.x, p.y, p));
        renderPinList();
      }
    } catch {
      alert('핀 데이터를 불러오는데 실패했습니다.');
    }
  }

  // --- 핀 히스토리 불러오기 ---
  async function loadHistory() {
    if (!currentPlaceId) return;
    try {
      const res = await apiFetch(`/api/places/${currentPlaceId}/history`);
      const data = await res.json();
      if (res.ok) {
        history = data.map(h => ({
          time: new Date(h.time).getTime(),
          text: `물건 위치가 변경되었습니다.`,
        }));
        renderHistory();
      }
    } catch {
      alert('히스토리 불러오기 실패');
    }
  }

  // --- 화면의 핀 다 지우기 ---
  function clearPinsFromMap() {
    const existingPins = floorplanContainer.querySelectorAll('.pin');
    existingPins.forEach(pin => pin.remove());
  }

  // --- 핀 생성 (DOM 및 드래그 이벤트) ---
  function createPin(x, y, pinData) {
    const pin = document.createElement('div');
    pin.className = 'pin';
    pin.style.left = `${x}px`;
    pin.style.top = `${y}px`;
    pin.style.backgroundColor = pinData.color || '#ff8c00';
    pin.textContent = pinData.emoji || '';
    pin.dataset.id = pinData.id;

    let offsetX, offsetY;
    let dragging = false;

    pin.addEventListener('mousedown', (e) => {
      if (!isMovingPin) return;
      dragging = true;
      offsetX = e.clientX - pin.offsetLeft;
      offsetY = e.clientY - pin.offsetTop;
      pin.classList.add('dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      let newX = e.clientX - offsetX;
      let newY = e.clientY - offsetY;
      const rect = floorplanContainer.getBoundingClientRect();
      newX = Math.min(Math.max(0, newX), rect.width - pin.offsetWidth);
      newY = Math.min(Math.max(0, newY), rect.height - pin.offsetHeight);

      pin.style.left = `${newX}px`;
      pin.style.top = `${newY}px`;
    });

    document.addEventListener('mouseup', async (e) => {
      if (!dragging) return;
      dragging = false;
      pin.classList.remove('dragging');

      // 위치 업데이트 서버에 저장
      const id = pin.dataset.id;
      const idx = pins.findIndex(p => p.id === id);
      if (idx === -1) return;

      pins[idx].x = parseInt(pin.style.left);
      pins[idx].y = parseInt(pin.style.top);

      // 핀 위치 수정 API 호출
      try {
        const pinToUpdate = pins[idx];
        await apiFetch(`/api/pins/${pinToUpdate.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            x: pinToUpdate.x,
            y: pinToUpdate.y,
          }),
        });

        // 히스토리 생성 API 호출
        await apiFetch(`/api/places/${currentPlaceId}/history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pin_id: pinToUpdate.id,
            x: pinToUpdate.x,
            y: pinToUpdate.y,
          }),
        });

        addHistory(`물건 "${pinToUpdate.name}" 위치 변경됨.`);
        renderHistory();
        renderPinList();
      } catch {
        alert('핀 위치 변경 저장 실패');
      }
    });

    floorplanContainer.appendChild(pin);
  }

  // --- 물건 리스트 렌더링 ---
  function renderPinList() {
    pinListDiv.innerHTML = '';
    pins.forEach(pin => {
      const div = document.createElement('div');
      div.className = 'pinItem';
      div.dataset.id = pin.id;
      div.innerHTML = `
        <div class="pinEmoji">${pin.emoji || '📌'}</div>
        <div class="pinName">${pin.name}</div>
        <div class="pinStatus">${pin.comment ? '코멘트 있음' : ''}</div>
      `;
      div.addEventListener('click', () => openEditModal(pin));
      pinListDiv.appendChild(div);
    });
  }

  // --- 히스토리 리스트 렌더링 ---
  function renderHistory() {
    historyListDiv.innerHTML = '';
    history.forEach(h => {
      const div = document.createElement('div');
      div.className = 'historyItem';
      div.textContent = `[${new Date(h.time).toLocaleString()}] ${h.text}`;
      historyListDiv.appendChild(div);
    });
  }

  // --- 물건 추가 버튼 ---
  addPinBtn.addEventListener('click', () => {
    if (!authToken) {
      alert('로그인 후 이용해주세요.');
      return;
    }
    addPinPopup.style.display = 'flex';
    addPinPopup.style.left = (floorplanContainer.clientWidth / 2 - addPinPopup.clientWidth / 2) + 'px';
    addPinPopup.style.top = (floorplanContainer.clientHeight / 2 - addPinPopup.clientHeight / 2) + 'px';

    newPinNameInput.value = '';
    newPinEmojiInput.value = '';
    newPinColorSelect.value = '#ff8c00';
  });

  // --- 물건 추가 팝업 확인 버튼 ---
  confirmAddPinBtn.addEventListener('click', async () => {
    const name = newPinNameInput.value.trim();
    const emoji = newPinEmojiInput.value.trim() || '';
    const color = newPinColorSelect.value;
    if (!name) {
      alert('물건 이름을 입력하세요.');
      return;
    }
    if (!currentPlaceId) {
      alert('장소가 선택되지 않았습니다.');
      return;
    }

    // 기본 위치 중앙
    const x = floorplanContainer.clientWidth / 2 - 16;
    const y = floorplanContainer.clientHeight / 2 - 16;

    try {
      const res = await apiFetch(`/api/places/${currentPlaceId}/pins`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, emoji, color, x, y }),
      });
      const data = await res.json();
      if (res.ok) {
        pins.push({
          id: data._id,
          name: data.name,
          emoji: data.emoji,
          color: data.color,
          x: data.x,
          y: data.y,
          comment: data.comment,
        });
        createPin(x, y, pins[pins.length - 1]);
        renderPinList();
        addPinPopup.style.display = 'none';
        addHistory(`물건 "${name}" 추가됨.`);
        renderHistory();
      } else {
        alert(data.error || '물건 추가 실패');
      }
    } catch {
      alert('서버 연결 실패');
    }
  });

  // --- 편집 모달 열기 ---
  function openEditModal(pin) {
    selectedPin = pin;
    editPinName.value = pin.name;
    editPinEmoji.value = pin.emoji || '';
    editPinComment.value = pin.comment || '';
    editPinColor.value = pin.color || '#ff8c00';
    editModal.style.display = 'flex';
  }

  // --- 편집 모달 저장 ---
  savePinBtn.addEventListener('click', async () => {
    if (!selectedPin) return;
    const name = editPinName.value.trim();
    const emoji = editPinEmoji.value.trim() || '';
    const comment = editPinComment.value.trim();
    const color = editPinColor.value;
    if (!name) {
      alert('물건 이름을 입력하세요.');
      return;
    }
    try {
      const res = await apiFetch(`/api/pins/${selectedPin.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, emoji, comment, color }),
      });
      if (res.ok) {
        selectedPin.name = name;
        selectedPin.emoji = emoji;
        selectedPin.comment = comment;
        selectedPin.color = color;
        updatePinOnMap(selectedPin);
        renderPinList();
        addHistory(`물건 "${name}" 정보 수정됨.`);
        renderHistory();
        closeEditModal();
      } else {
        const data = await res.json();
        alert(data.error || '수정 실패');
      }
    } catch {
      alert('서버 연결 실패');
    }
  });

  // --- 편집 모달 삭제 ---
  deletePinBtn.addEventListener('click', async () => {
    if (!selectedPin) return;
    if (!confirm(`정말 "${selectedPin.name}" 을(를) 삭제하시겠습니까?`)) return;
    try {
      const res = await apiFetch(`/api/pins/${selectedPin.id}`, {
        method: 'DELETE',
      });
      if (res.ok) {
        const idx = pins.findIndex(p => p.id === selectedPin.id);
        if (idx !== -1) pins.splice(idx, 1);

        const domPin = floorplanContainer.querySelector(`.pin[data-id="${selectedPin.id}"]`);
        if (domPin) domPin.remove();

        renderPinList();
        addHistory(`물건 "${selectedPin.name}" 삭제됨.`);
        renderHistory();
        closeEditModal();
      } else {
        const data = await res.json();
        alert(data.error || '삭제 실패');
      }
    } catch {
      alert('서버 연결 실패');
    }
  });

  cancelBtn.addEventListener('click', () => closeEditModal());

  function closeEditModal() {
    selectedPin = null;
    editModal.style.display = 'none';
  }

  // --- 핀 화면 업데이트 ---
  function updatePinOnMap(pinData) {
    const domPin = floorplanContainer.querySelector(`.pin[data-id="${pinData.id}"]`);
    if (!domPin) return;
    domPin.style.left = pinData.x + 'px';
    domPin.style.top = pinData.y + 'px';
    domPin.style.backgroundColor = pinData.color;
    domPin.textContent = pinData.emoji;
  }

  // --- 히스토리 추가 (로컬) ---
  function addHistory(text) {
    history.unshift({ time: Date.now(), text });
  }

  // --- 물건 옮기기 토글 ---
  movePinBtn.addEventListener('click', () => {
    isMovingPin = !isMovingPin;
    movePinBtn.textContent = isMovingPin ? '옮기기 중 (클릭하여 종료)' : '물건 옮기기';
    floorplanContainer.style.cursor = isMovingPin ? 'grab' : 'default';
  });

  // --- 탭 전환 ---
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (btn.dataset.tab === 'pinList') {
        pinListDiv.style.display = 'block';
        historyListDiv.style.display = 'none';
      } else {
        pinListDiv.style.display = 'none';
        historyListDiv.style.display = 'block';
      }
    });
  });

  // --- 초기 화면 설정 ---
  function init() {
    startScreen.style.display = 'block';
    mainApp.style.display = 'none';
    mainApp.classList.add('sidebar-visible');
  }

  init();

  // --- 사이드바 토글 ---
  const sidebar = document.getElementById('sidebar');
  const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
  toggleSidebarBtn.addEventListener('click', () => {
    const isVisible = window.getComputedStyle(sidebar).display !== 'none';
    if (isVisible) {
      sidebar.style.display = 'none';
    } else {
      sidebar.style.display = 'flex';
    }
    mainApp.classList.toggle('sidebar-visible', !isVisible);
    mainApp.classList.toggle('sidebar-collapsed', isVisible);
  });
})();
</script>

</body>

</html>
